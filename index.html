<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Salud AR - WebXR + Cloud</title>
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- MOTOR AR ESTABLE (Reemplaza MindAR) -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- FIREBASE SDKs (Restaurados para compartir/GPS) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD25y6TynkWWwD72sPod5cOWmq0SYPIp6I",
            authDomain: "ar-constructor-v2.firebaseapp.com",
            projectId: "ar-constructor-v2",
            storageBucket: "ar-constructor-v2.firebasestorage.app",
            messagingSenderId: "916569604582",
            appId: "1:916569604582:web:5ad942651ce8269f895627"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.storage = getStorage(app);

        // Login an√≥nimo autom√°tico para poder subir datos
        signInAnonymously(window.auth).then(user => {
            console.log("Conectado a nube como:", user.user.uid);
            window.currentUser = user.user;
        }).catch(console.error);
    </script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>

    <style>
        /* Estilos Base */
        html.ar-active,
        body.ar-active {
            overflow: hidden !important;
            width: 100vw !important;
            height: 100vh !important;
            background: black;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        #editor-canvas {
            width: 100%;
            height: 400px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        /* Estilos AR */
        #ar-scene-container {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: none;
            background: black;
        }

        #ar-scene-container.active {
            display: block;
        }

        #ar-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            p: 4;
        }

        .ar-btn {
            pointer-events: auto;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 11000;
        }

        #toast.show {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 font-sans selection:bg-indigo-100">

    <div id="toast">Notificaci√≥n</div>

    <div id="app" class="container mx-auto p-4 max-w-4xl pb-24">
        <!-- Header -->
        <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 flex items-center gap-4 border border-slate-100">
            <img src="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/logofundacion.jpg"
                class="h-12 rounded" onerror="this.src='https://placehold.co/50'">
            <div>
                <h1 class="text-xl font-black text-indigo-900 leading-tight">Salud AR <span
                        class="text-xs bg-green-100 text-green-700 px-2 rounded-full">Pro</span></h1>
                <p class="text-xs text-slate-400">Visualizaci√≥n & Metadatos GPS</p>
            </div>
        </div>

        <!-- PASO 1: RECURSOS -->
        <div id="page-upload" class="page active">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <span
                        class="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                    Gesti√≥n de Modelos
                </h2>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="downloadAssets()"
                        class="bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-indigo-200 shadow-lg hover:bg-indigo-700 transition">üì•
                        Descargar Pack</button>
                    <button onclick="clearCache()"
                        class="bg-white text-red-500 border border-red-100 py-3 rounded-xl font-bold text-sm hover:bg-red-50">üóëÔ∏è
                        Limpiar</button>
                </div>

                <div id="preview-grid" class="grid grid-cols-4 gap-2 mb-4 min-h-[100px] bg-slate-50 rounded-xl p-2">
                    <!-- Se llena dinamicamente -->
                    <p class="col-span-4 text-center text-xs text-slate-400 py-8">No hay modelos descargados</p>
                </div>

                <button onclick="navigateTo('page-editor')" id="btn-next-1" disabled
                    class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                    Siguiente: Editar &rarr;
                </button>
            </div>
        </div>

        <!-- PASO 2: EDITOR & METADATOS -->
        <div id="page-editor" class="page">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg flex items-center gap-2">
                        <span
                            class="bg-indigo-100 text-indigo-600 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                        Ajuste & Datos
                    </h2>
                    <button onclick="shareProject()"
                        class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-bold border border-blue-100 hover:bg-blue-100">
                        üîó Compartir URL
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <div class="md:w-1/3 space-y-3">
                        <select id="asset-selector"
                            class="w-full p-2 bg-slate-50 border rounded-lg text-sm font-bold text-slate-700"></select>

                        <!-- Panel de Transformaci√≥n Compacto -->
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Escala</p>
                            <input type="range" id="scale-slider" min="0.1" max="3" step="0.1" value="1"
                                class="w-full accent-indigo-600">
                            <div class="flex justify-between text-xs font-mono mt-1">
                                <span>0.1x</span>
                                <span id="scale-val">1.0x</span>
                                <span>3.0x</span>
                            </div>
                        </div>

                        <!-- Panel de Metadatos (Restaurado) -->
                        <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100">
                            <p class="text-[10px] uppercase font-bold text-yellow-600 mb-1">üìç Geo-Etiqueta (GPS)</p>
                            <div class="flex items-center gap-2">
                                <button onclick="captureGPS()"
                                    class="bg-yellow-100 text-yellow-700 p-2 rounded-lg text-xs font-bold hover:bg-yellow-200">üì°
                                    Capturar</button>
                                <span id="gps-display" class="text-[10px] font-mono text-slate-500">Sin datos</span>
                            </div>
                        </div>
                    </div>

                    <div
                        class="md:w-2/3 h-[300px] bg-slate-100 rounded-xl overflow-hidden relative border border-slate-200">
                        <canvas id="editor-canvas"></canvas>
                        <div class="absolute bottom-2 right-2 text-[10px] bg-white/80 px-2 rounded backdrop-blur">Vista
                            Previa 3D</div>
                    </div>
                </div>

                <div class="flex gap-3 mt-4">
                    <button onclick="navigateTo('page-upload')"
                        class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Atr√°s</button>
                    <button onclick="launchAR()"
                        class="flex-[2] bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200">
                        üì∑ Ver en Realidad
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR AR COMPLETO -->
    <div id="ar-scene-container">
        <!-- Model Viewer injectado aqui -->
    </div>

    <!-- AR UI OVERLAY -->
    <div id="ar-overlay" class="hidden">
        <div class="w-full p-4 bg-gradient-to-b from-black/80 to-transparent text-white pointer-events-none">
            <h3 class="font-bold text-sm shadow-black drop-shadow-md">Modo WebXR</h3>
            <p id="ar-gps-info" class="text-xs font-mono text-yellow-300">GPS: Esperando...</p>
        </div>
        <div class="w-full p-6 flex justify-center pointer-events-none">
            <button onclick="stopAR()"
                class="ar-btn bg-red-600 text-white px-8 py-3 rounded-full font-black shadow-2xl border border-white/20">
                ‚õî SALIR
            </button>
        </div>
    </div>

    <!-- MODAL COMPARTIR -->
    <div id="share-modal"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl text-center">
            <h3 class="text-xl font-black text-indigo-900 mb-2">Proyecto Compartido</h3>
            <p class="text-sm text-slate-500 mb-4">Tu modelo y coordenadas han sido subidos.</p>

            <input type="text" id="share-url"
                class="w-full bg-slate-100 p-3 rounded-lg text-xs font-mono mb-4 text-center select-all" readonly>

            <button onclick="document.getElementById('share-modal').classList.add('hidden')"
                class="bg-slate-800 text-white w-full py-3 rounded-xl font-bold">Cerrar</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SISTEMA ---
        const CACHE_NAME = 'ar-medical-cache-v2';
        const GITHUB_BASE = 'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/';

        const DB_ASSETS = [
            { id: 101, name: 'Cabeza', file: 'dedo', img: 'dedo.png' },
            { id: 102, name: 'Coraz√≥n', file: 'dedo-mano', img: 'dedo-mano.png' },
            { id: 103, name: 'Columna', file: 'hueso-columna', img: 'hueso-columna.png' },
            { id: 104, name: 'Mano Huesos', file: 'huesosmano', img: 'huesosmano.png' },
            { id: 105, name: 'Pr√≥tesis', file: 'mano-iz-protesis', img: 'mano-iz-protesis.png' },
            { id: 106, name: 'Brazo', file: 'protesis-mano-brazo', img: 'protesis-mano-brazo.png' },
            { id: 107, name: 'Cr√°neo', file: 'cabeza1', img: 'cabeza1.png' },
            { id: 108, name: 'Coraz√≥n Detalle', file: 'corazon', img: 'corazon.png' }
        ];

        const state = {
            assets: [],
            currentAsset: null,
            gps: { lat: null, lon: null },
            editor: { scene: null, camera: null, renderer: null, model: null }
        };

        // --- FUNCIONES CORE ---
        window.init = async () => {
            initThree();
            const cached = await loadCache();
            if (cached) {
                state.assets = cached;
                renderAssets();
                document.getElementById('btn-next-1').disabled = false;
            }
        };

        window.downloadAssets = async () => {
            showToast("Iniciando descarga...");
            const cache = await caches.open(CACHE_NAME);
            const downloaded = [];

            for (const item of DB_ASSETS) {
                try {
                    // Modelo
                    const mResp = await fetch(`${GITHUB_BASE}modelss/${item.file}.glb`);
                    const mBlob = await mResp.blob();
                    await cache.put(`${GITHUB_BASE}modelss/${item.file}.glb`, new Response(mBlob));

                    // Imagen
                    const iResp = await fetch(`${GITHUB_BASE}imagenes/${item.img}`);
                    const iBlob = await iResp.blob();
                    await cache.put(`${GITHUB_BASE}imagenes/${item.img}`, new Response(iBlob));

                    downloaded.push({ ...item, modelBlob: mBlob, imgBlob: iBlob });
                } catch (e) { console.error(e); }
            }

            state.assets = downloaded;
            renderAssets();
            document.getElementById('btn-next-1').disabled = false;
            showToast("¬°Recursos descargados!");
        };

        window.loadCache = async () => {
            const cache = await caches.open(CACHE_NAME);
            const loaded = [];
            for (const item of DB_ASSETS) {
                const mRes = await cache.match(`${GITHUB_BASE}modelss/${item.file}.glb`);
                const iRes = await cache.match(`${GITHUB_BASE}imagenes/${item.img}`);
                if (mRes && iRes) {
                    loaded.push({ ...item, modelBlob: await mRes.blob(), imgBlob: await iRes.blob() });
                }
            }
            return loaded.length > 0 ? loaded : null;
        };

        window.clearCache = async () => {
            await caches.delete(CACHE_NAME);
            window.location.reload();
        };

        window.renderAssets = () => {
            const grid = document.getElementById('preview-grid');
            const selector = document.getElementById('asset-selector');
            grid.innerHTML = ''; selector.innerHTML = '';

            state.assets.forEach((a, idx) => {
                const url = URL.createObjectURL(a.imgBlob);
                grid.innerHTML += `<div class="aspect-square bg-slate-200 rounded-lg overflow-hidden border"><img src="${url}" class="w-full h-full object-cover"></div>`;
                selector.innerHTML += `<option value="${idx}">${a.name}</option>`;
            });

            if (state.assets.length > 0) selectAsset(0);
        };

        // --- EDITOR & LOGIC ---
        window.selectAsset = (idx) => {
            const asset = state.assets[idx];
            if (!asset) return;
            state.currentAsset = asset;
            const url = URL.createObjectURL(asset.modelBlob);

            // Cargar en ThreeJS
            if (state.editor.model) state.editor.scene.remove(state.editor.model);
            const loader = new GLTFLoader();
            loader.load(url, (gltf) => {
                state.editor.model = gltf.scene;
                state.editor.scene.add(gltf.scene);
                // Auto center
                const box = new THREE.Box3().setFromObject(gltf.scene);
                gltf.scene.position.sub(box.getCenter(new THREE.Vector3()));
            });

            // Reset escala
            document.getElementById('scale-slider').value = 1;
            document.getElementById('scale-val').textContent = "1.0x";
        };

        document.getElementById('asset-selector').addEventListener('change', (e) => selectAsset(e.target.value));

        document.getElementById('scale-slider').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('scale-val').textContent = val + "x";
            if (state.editor.model) state.editor.model.scale.setScalar(val);
        });

        // --- GPS LOGIC (RESTAURADA) ---
        window.captureGPS = () => {
            if (!navigator.geolocation) return showToast("GPS no soportado");
            navigator.geolocation.getCurrentPosition((pos) => {
                state.gps = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                document.getElementById('gps-display').textContent = `${state.gps.lat.toFixed(5)}, ${state.gps.lon.toFixed(5)}`;
                document.getElementById('ar-gps-info').textContent = `GPS: ${state.gps.lat.toFixed(5)}, ${state.gps.lon.toFixed(5)}`;
                showToast("üìç Posici√≥n capturada");
            }, (err) => showToast("Error GPS: " + err.message));
        };

        // --- SHARING LOGIC (RESTAURADA) ---
        // Implementaci√≥n simplificada pero funcional usando Firestore an√≥nimo
        window.shareProject = async () => {
            if (!window.currentUser) return showToast("Conectando servicio nube...");
            if (!state.currentAsset) return showToast("Selecciona un modelo");

            showToast("Subiendo metadatos...");

            try {
                // Subimos ficha a Firestore
                const docRef = await window.addDoc(window.collection(window.db, "shared_projects"), {
                    assetName: state.currentAsset.name,
                    gps: state.gps,
                    scale: document.getElementById('scale-slider').value,
                    createdAt: new Date().toISOString(),
                    uid: window.currentUser.uid
                });

                const shareUrl = `${window.location.host}${window.location.pathname}?id=${docRef.id}`;
                document.getElementById('share-url').value = shareUrl;
                document.getElementById('share-modal').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                showToast("Error al compartir: " + e.message);
            }
        };

        // --- AR LAUNCHER ---
        window.launchAR = () => {
            if (!state.currentAsset) return;
            const container = document.getElementById('ar-scene-container');
            const scale = document.getElementById('scale-slider').value;

            // Model Viewer Element
            const mv = document.createElement('model-viewer');
            mv.src = URL.createObjectURL(state.currentAsset.modelBlob);
            mv.setAttribute('ar', '');
            mv.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
            mv.setAttribute('camera-controls', '');
            mv.setAttribute('auto-rotate', '');
            mv.setAttribute('shadow-intensity', '1');
            mv.scale = `${scale} ${scale} ${scale}`;
            mv.style.width = '100%'; mv.style.height = '100%';

            container.innerHTML = '';
            container.appendChild(mv);
            container.classList.add('active');
            document.getElementById('ar-overlay').classList.remove('hidden');

            // Activar GPS tracking continuo en UI
            if (navigator.geolocation) {
                window.gpsWatch = navigator.geolocation.watchPosition(p => {
                    document.getElementById('ar-gps-info').textContent = `GPS: ${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`;
                });
            }

            setTimeout(() => { try { mv.activateAR(); } catch (e) { } }, 100);
        };

        window.stopAR = () => {
            document.getElementById('ar-scene-container').classList.remove('active');
            document.getElementById('ar-overlay').classList.add('hidden');
            document.getElementById('ar-scene-container').innerHTML = ''; // Kill AR session
            if (window.gpsWatch) navigator.geolocation.clearWatch(window.gpsWatch);
        };

        // --- UTILS ---
        window.navigateTo = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        function initThree() {
            const cvs = document.getElementById('editor-canvas');
            const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf1f5f9);
            const camera = new THREE.PerspectiveCamera(45, cvs.clientWidth / cvs.clientHeight, 0.1, 100); camera.position.set(0, 1, 3);
            const renderer = new THREE.WebGLRenderer({ canvas: cvs, antialias: true }); renderer.setSize(cvs.clientWidth, cvs.clientHeight);
            const controls = new OrbitControls(camera, cvs); controls.enableDamping = true;
            scene.add(new THREE.AmbientLight(0xffffff, 1));
            const dl = new THREE.DirectionalLight(0xffffff, 2); dl.position.set(2, 5, 2); scene.add(dl);
            state.editor = { scene, camera, renderer, controls, model: null };
            const animate = () => { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); };
            animate();
        }

        window.addEventListener('load', init);

    </script>
</body>

</html>
