<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Libro para Colorear con Realidad Aumentada</title>
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
            }
        }
    </script>
    <style>
        /* Estilos generales y para el modo AR (sin cambios significativos) */
        html.ar-active, body.ar-active { overflow: hidden; width: 100%; height: 100%; margin: 0; padding: 0; }
        #app { transition: all 0.3s ease-in-out; }
        .app-container.ar-fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; max-height: none; padding: 0; margin: 0 !important; border-radius: 0; overflow: hidden; }
        .app-container.ar-fullscreen .page.active { height: 100%; }
        .page { display: none; }
        .page.active { display: block; }
        #editor-canvas { width: 100%; height: 400px; border: 1px solid #ccc; background: #f0f0f0; cursor: move; touch-action: none; border-radius: 8px; }
        #ar-scene-container.ar-active { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9990; }
        #ar-scene-container.ar-active a-scene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #ar-scene-container.ar-active video, 
        #ar-scene-container.ar-active canvas { position: absolute !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; min-width: 100% !important; min-height: 100% !important; width: auto !important; height: auto !important; object-fit: cover !important; cursor: grab; }
        #ar-active-controls { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 9999; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #scanning-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9991; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; background-color: rgba(0,0,0,0.3); transition: opacity 0.3s; }
        #scanning-ui.hidden { display: none; }
        .scan-text { margin-top: 24px; padding: 8px 16px; background-color: rgba(0,0,0,0.5); color: white; font-size: 1.1rem; border-radius: 8px; text-shadow: 1px 1px 2px black; }
    </style>
</head>
<body class="bg-gray-200 text-gray-800 font-sans">
    
    <div id="app" class="app-container container mx-auto p-6 md:p-8 max-w-5xl bg-white rounded-xl shadow-lg my-8 overflow-y-auto" style="max-height: 85vh;">
        <div class="flex justify-center items-center mb-6">
             <img src="https://placehold.co/120x80/e2e8f0/94a3b8?text=Logo" alt="Logo" class="h-20 w-auto mr-4">
             <div>
                 <h1 class="text-3xl md:text-4xl font-bold text-center" style="color: #1e3a8a;">Libro para Colorear con Realidad Aumentada</h1>
                 <p class="text-center text-gray-500">Paso 1: ¡Apunta la cámara a tu dibujo!</p>
             </div>
        </div>

        <!-- PÁGINA ÚNICA PARA LA APP DE COLOREAR -->
        <div id="page-ar" class="page active">
             <div class="relative">
                 <div id="ar-ui-container" class="relative z-10">
                     <h2 class="text-2xl font-semibold mb-4 text-center">Vista de Realidad Aumentada</h2>
                     <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                         <p class="text-center">Apunta tu cámara a la página del libro para colorear. Los colores que pintes aparecerán en el modelo 3D. <strong>Puedes girar el modelo 3D deslizando el dedo.</strong></p>
                         <div id="ar-status" class="text-center font-mono p-2 bg-gray-100 rounded mt-2 flex justify-center items-center gap-2">
                             <div class="loader hidden"></div>
                             <span id="ar-status-text">Estado: Esperando para iniciar...</span>
                         </div>
                     </div>                                         
                     <div class="mt-6 flex justify-center items-center gap-4">
                         <button id="start-ar-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-300 text-lg shadow-md flex items-center justify-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                             Iniciar AR
                         </button>
                     </div>
                 </div>
                 <div id="ar-scene-container"></div>
                 <div id="scanning-ui" class="hidden">
                     <p class="scan-text">Apunte al marcador de la página</p>
                 </div>
                 <div id="ar-active-controls" class="hidden p-4 bg-black bg-opacity-50">
                     <div class="relative flex justify-center items-center gap-4 max-w-4xl mx-auto">
                         <button id="stop-ar-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">Detener Cámara</button>
                     </div>
                 </div>
             </div>
        </div>
    </div>

    <div id="ar-preloader" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col justify-center items-center z-[10000]">
        <div class="loader"></div>
        <p id="preloader-text" class="text-white text-lg mt-4">Iniciando cámara...</p>
    </div>

    <script type="module">
    import * as THREE from 'three';
    
    // =================================================================================
    // COMPONENTE A-FRAME: texture-from-video
    // (Sin cambios en este componente)
    // =================================================================================
    AFRAME.registerComponent('texture-from-video', {
        schema: {},
        init: function () {
            this.sceneEl = this.el.sceneEl; this.model = null; this.textureCanvas = null; this.textureContext = null; this.texture = null; this.video = null;
            this.el.addEventListener('model-loaded', () => { this.model = this.el.getObject3D('mesh'); this.setupTexture(); });
            this.sceneEl.addEventListener('arReady', () => { this.video = document.querySelector('video'); });
        },
        setupTexture: function() {
            if (!this.model) return;
            this.textureCanvas = document.createElement('canvas'); this.textureCanvas.width = 512; this.textureCanvas.height = 512;
            this.textureContext = this.textureCanvas.getContext('2d');
            this.texture = new THREE.CanvasTexture(this.textureCanvas);
            this.texture.minFilter = THREE.LinearFilter; this.texture.magFilter = THREE.LinearFilter; this.texture.colorSpace = THREE.SRGBColorSpace;
            this.model.traverse((node) => {
                if (node.isMesh && node.material) {
                    node.material = node.material.clone(); node.material.map = this.texture; node.material.needsUpdate = true;
                }
            });
        },
        tick: function() {
            const mindarSystem = this.sceneEl.systems['mindar-image-system'];
            if (this.video && this.textureContext && mindarSystem && this.el.object3D.visible) {
                const markerCorners = mindarSystem.getMarkerWorldPosition(0);
                if (markerCorners) {
                    this.textureContext.clearRect(0, 0, this.textureCanvas.width, this.textureCanvas.height);
                    const screenCoords = markerCorners.map(corner => {
                        const vector = new THREE.Vector3(corner.x, corner.y, corner.z).project(this.sceneEl.camera);
                        return { x: (vector.x + 1) * this.video.videoWidth / 2, y: (-vector.y + 1) * this.video.videoHeight / 2 };
                    });
                    this.drawPerspectiveCorrectedImage(screenCoords);
                    this.texture.needsUpdate = true;
                }
            }
        },
        drawPerspectiveCorrectedImage: function(points) {
            const ctx = this.textureContext, canvas = this.textureCanvas;
            const to = [{ x: 0, y: 0 }, { x: canvas.width, y: 0 }, { x: canvas.width, y: canvas.height }, { x: 0, y: canvas.height }];
            ctx.save(); ctx.beginPath(); ctx.moveTo(to[0].x, to[0].y); ctx.lineTo(to[1].x, to[1].y); ctx.lineTo(to[2].x, to[2].y); ctx.lineTo(to[3].x, to[3].y); ctx.closePath(); ctx.clip();
            this.drawTriangle(points[0], points[1], points[3], to[0], to[1], to[3]);
            this.drawTriangle(points[1], points[2], points[3], to[1], to[2], to[3]);
            ctx.restore();
        },
        drawTriangle: function(p0, p1, p2, t0, t1, t2) {
            const ctx = this.textureContext, video = this.video;
            ctx.beginPath(); ctx.moveTo(t0.x, t0.y); ctx.lineTo(t1.x, t1.y); ctx.lineTo(t2.x, t2.y); ctx.closePath(); ctx.clip();
            const det = p1.x * p2.y + p0.x * p1.y + p2.x * p0.y - p1.x * p0.y - p2.x * p1.y - p0.x * p2.y;
            const a = (p2.y * t0.x - p0.y * t2.x + (p0.y - p2.y) * t1.x) / det, b = (p2.x * t0.x - p0.x * t2.x + (p0.x - p2.x) * t1.x) / det, c = t0.x - a * p0.x - b * p0.y;
            const d = (p2.y * t0.y - p0.y * t2.y + (p0.y - p2.y) * t1.y) / det, e = (p2.x * t0.y - p0.x * t2.y + (p0.x - p2.x) * t1.y) / det, f = t0.y - d * p0.x - e * p0.y;
            ctx.transform(a, d, b, e, c, f); ctx.drawImage(video, 0, 0);
        }
    });

    // =================================================================================
    // COMPONENTE A-FRAME: ar-rotator
    // (Sin cambios en este componente)
    // =================================================================================
    AFRAME.registerComponent('ar-rotator', {
        schema: { rotationFactor: { type: 'number', default: 1 } },
        init: function () {
            this.isVisible = false; this.isDragging = false; this.previousDrag = { x: 0, y: 0 }; const canvas = this.el.sceneEl.canvas;
            const startDrag = (x, y) => { if (this.isVisible) { this.isDragging = true; this.previousDrag = { x, y }; } };
            const drag = (x, y) => { if (this.isDragging && this.isVisible) { const deltaX = x - this.previousDrag.x; const deltaY = y - this.previousDrag.y; this.el.object3D.rotation.y += THREE.MathUtils.degToRad(deltaX * this.data.rotationFactor); this.el.object3D.rotation.x += THREE.MathUtils.degToRad(deltaY * this.data.rotationFactor); this.previousDrag = { x, y }; } };
            const endDrag = () => { this.isDragging = false; };
            canvas.addEventListener('touchstart', (e) => { if (e.touches.length === 1) startDrag(e.touches[0].clientX, e.touches[0].clientY); }); canvas.addEventListener('touchmove', (e) => { if (e.touches.length === 1) drag(e.touches[0].clientX, e.touches[0].clientY); }); canvas.addEventListener('touchend', endDrag); canvas.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY)); canvas.addEventListener('mousemove', (e) => drag(e.clientX, e.clientY)); canvas.addEventListener('mouseup', endDrag); canvas.addEventListener('mouseleave', endDrag);
            this.el.parentEl.addEventListener('targetFound', () => { this.isVisible = true; }); this.el.parentEl.addEventListener('targetLost', () => { this.isVisible = false; });
        },
    });

    document.addEventListener('DOMContentLoaded', () => {
        const state = { isArActive: false };
        const arStatusText = document.getElementById('ar-status-text');
        const arStatusLoader = document.querySelector('#ar-status .loader');
        const startButton = document.getElementById('start-ar-btn');

        function setupAndStartAR() {
            startButton.disabled = true;
            arStatusLoader.classList.remove('hidden');
            arStatusText.textContent = 'Iniciando AR...';

            document.getElementById('preloader-text').textContent = "Cargando recursos...";
            document.getElementById('ar-preloader').classList.remove('hidden');
            const arSceneContainer = document.getElementById('ar-scene-container');
            arSceneContainer.innerHTML = ''; 

            const markerUrl = 'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/markers/cabeza1.mind';
            const modelUrl = 'https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/modelss/dedo.glb';

            const sceneHTML = `
                <a-scene id="ar-scene" embedded vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" mindar-image="imageTargetSrc: ${markerUrl}; autoStart: false;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights">
                    <a-assets> <a-asset-item id="coloring-model" src="${modelUrl}"></a-asset-item> </a-assets>
                    <a-camera position="0 0 0" look-controls="enabled: false" fov="75"></a-camera>
                    <a-entity mindar-image-target="targetIndex: 0">
                        <a-gltf-model src="#coloring-model" position="0 -0.25 0" rotation="0 0 0" scale="0.5 0.5 0.5" ar-rotator texture-from-video></a-gltf-model>
                    </a-entity>
                </a-scene>`;
            arSceneContainer.innerHTML = sceneHTML;

            const sceneEl = document.getElementById('ar-scene');
            const modelAsset = document.getElementById('coloring-model');

            // =====================================================================
            // NUEVA LÓGICA DE GESTIÓN DE ERRORES
            // =====================================================================
            let markerLoadTimeout;

            modelAsset.addEventListener('loaded', () => {
                arStatusText.textContent = 'Modelo 3D cargado. Iniciando cámara...';
                document.getElementById('preloader-text').textContent = "Iniciando cámara...";

                // Ahora que el modelo cargó, iniciamos la escena de MindAR
                sceneEl.systems['mindar-image-system'].start();

                markerLoadTimeout = setTimeout(() => {
                    arStatusText.innerHTML = '<span class="text-red-500 font-semibold">Error: El marcador (.mind) no cargó a tiempo.</span>';
                    arStatusLoader.classList.add('hidden');
                    startButton.disabled = false;
                    document.getElementById('ar-preloader').classList.add('hidden');
                }, 15000);
            });

            modelAsset.addEventListener('error', () => {
                arStatusText.innerHTML = '<span class="text-red-500 font-semibold">Error al cargar el modelo 3D (.glb).</span>';
                arStatusLoader.classList.add('hidden');
                startButton.disabled = false;
                document.getElementById('ar-preloader').classList.add('hidden');
            });
            
            sceneEl.addEventListener('arReady', () => {
                clearTimeout(markerLoadTimeout); // El marcador cargó correctamente
                document.getElementById('ar-preloader').classList.add('hidden');
                const appContainer = document.getElementById('app');
                document.documentElement.classList.add('ar-active');
                document.body.classList.add('ar-active');
                appContainer.classList.add('ar-fullscreen');
                arSceneContainer.classList.add('ar-active');
                document.getElementById('ar-ui-container').classList.add('hidden');
                document.getElementById('ar-active-controls').classList.remove('hidden');
                document.getElementById('scanning-ui').classList.remove('hidden');
                state.isArActive = true;
            });

            sceneEl.addEventListener('targetFound', () => document.getElementById('scanning-ui').classList.add('hidden'));
            sceneEl.addEventListener('targetLost', () => document.getElementById('scanning-ui').classList.remove('hidden'));
        }

        function stopAR() {
            const arSceneContainer = document.getElementById('ar-scene-container');
            const sceneEl = arSceneContainer.querySelector('a-scene');
            if (sceneEl && sceneEl.systems['mindar-image-system']) { 
                sceneEl.systems['mindar-image-system'].stop();
                if (sceneEl.parentNode) sceneEl.parentNode.removeChild(sceneEl);
            }
            arSceneContainer.innerHTML = '';
            
            const appContainer = document.getElementById('app');
            document.documentElement.classList.remove('ar-active');
            document.body.classList.remove('ar-active');
            appContainer.classList.remove('ar-fullscreen');
            document.getElementById('ar-ui-container').classList.remove('hidden');
            document.getElementById('ar-active-controls').classList.add('hidden');
            document.getElementById('scanning-ui').classList.add('hidden');                        
            state.isArActive = false;
            startButton.disabled = false;
            arStatusLoader.classList.add('hidden');
            arStatusText.textContent = 'Estado: Esperando para iniciar...';
        }                

        startButton.addEventListener('click', setupAndStartAR);
        document.getElementById('stop-ar-btn').addEventListener('click', stopAR);
    });
    </script>
</body>
</html>

